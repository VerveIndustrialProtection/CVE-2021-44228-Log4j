<?xml version="1.0" encoding="UTF-8"?>
<BES xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="BES.xsd">
	<Fixlet>
		<Title>Invoke - Verve Log4j Enhanced Detector - Windows</Title>
		<Description><![CDATA[<P>Invokes the Verve Log4j Enhanced Detector to detect if any running processes have Log4j loaded or if they have a JAR/WAR/EAR/AAR loaded that contains Log4j. There are two actions available, one that looks at all processes and one that just looks at Java processes.&nbsp;The Fixlets, "Warning - Verve Log4j Detector reports CVE-####-#### - Universal" will become relevant on machines with vulnerable Log4j versions shortly after this Fixlet completes.</P>
<P>To target only&nbsp;systems actively running java, target the computer group "Systems running Java Processes" that was packaged with this fixlet.</P>
<P><STRONG>Notes<BR></STRONG>This&nbsp;Fixlet does look within JAR, WAR, EAR, AAR, etc files to see if Log4j is embedded inside of them -- as a result, this Fixlet has a higher impact on the system, requires a portable JRE and takes more time.&nbsp;If you do not need this added functionality see the Verve Log4j Detector.</P>
<P>This Fixlet takes into account whether or not the JNDI class has been removed from the JAR before marking it as vulnerable.</P>
<P><STRONG>Testing</STRONG><BR>You should always test all BigFix content on a representative set of test systems before applying it to production systems. Do not apply content you have not reviewed, tested, and have a real understanding of how it will impact your systems.</P>
<P><STRONG>Copyright Verve Industrial Protection 2021</STRONG><BR>This content is produced, maintained and copyrighted by Verve Industrial Protection. You may use and distribute this content freely but you may not remove this notice. If you modify this content or derive other content from this content you must make the modified content available for free under these same terms. This content carries no Express or Implied Warranty. THE LICENSED PROPERTY IS PROVIDED "AS IS", WITH ALL FAULTS. THERE ARE NO WARRANTIES OR GUARANTEES, EXPRESS OR IMPLIED, RELATING TO THE VERVE INDUSTRIAL PROTECTION IP, THE PROPRIETARY KNOWLEDGE, OR OTHER SERVICES OR PRODUCTS TO BE PROVIDED HEREUNDER, OR ANY PROSPECTS OR OUTCOME THEREOF. VERVE INDUSTRIAL PROTECTION DISCLAIMS ANY AND ALL, AND INSTRUCTOR ACKNOWLEDGES AND AGREES THAT THERE ARE NO, REPRESENTATIONS, WARRANTIES, COVENANTS, OR CONDITIONS, WHETHER EXPRESS, IMPLIED, ARISING AT LAW, IN EQUITY, OR BY CUSTOM OF TRADE, STATUTORY OR OTHERWISE, ORAL OR WRITTEN, INCLUDING WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, NON-INFRINGEMENT, TITLE OR QUIET ENJOYMENT. FURTHER, VERVE INDUSTRIAL PROTECTION DOES NOT WARRANT THAT THE LICENSED PROPERTY IS ERROR-FREE OR WILL BE AVAILABLE AT ALL TIMES OR OPERATE WITHOUT INTERRUPTION. NO ORAL OR WRITTEN INFORMATION OR ADVICE GIVEN BY VERVE INDUSTRIAL PROTECTION, ITS AGENTS, OR ITS EMPLOYEES, AT ANY TIME SHALL CREATE A WARRANTY OF ANY KIND. SOME STATES OR JURISDICTIONS DO NOT ALLOW THE EXCLUSION OF EXPRESS OR IMPLIED WARRANTIES, SO THE ABOVE EXCLUSION MAY NOT APPLY TO YOU. IN THAT EVENT, WARRANTIES SHALL ONLY BE IMPOSED TO THE EXTENT DETERMINED BY A COURT OF COMPETENT JURISDICTION AS REQUIRED BY APPLICABLE LAW.<BR></P>]]></Description>
		<Relevance>windows of operating system</Relevance>
		<Relevance><![CDATA[version of operating system >= "5.1"]]></Relevance>
		<Relevance><![CDATA[(not exists modification times whose (it > (now - 30 * minute)) of files "start.out" of folders "__Global/Verve/Detections/Log4j/Recent" of data folders of client)]]></Relevance>
		<Category></Category>
		<Source>Internal</Source>
		<SourceID></SourceID>
		<SourceReleaseDate>2021-12-17</SourceReleaseDate>
		<SourceSeverity></SourceSeverity>
		<CVENames></CVENames>
		<SANSID></SANSID>
		<MIMEField>
			<Name>x-fixlet-modification-time</Name>
			<Value>Sun, 19 Dec 2021 21:06:45 +0000</Value>
		</MIMEField>
		<Domain>BESC</Domain>
		<DefaultAction ID="Action2">
			<Description>
				<PreLink>Click </PreLink>
				<Link>here</Link>
				<PostLink><![CDATA[&nbsp;to inspect all processes for vulnerable embedded Log4j components.]]></PostLink>
			</Description>
			<ActionScript MIMEType="application/x-Fixlet-Windows-Shell"><![CDATA[// The only difference between these two actions is the "Query" and "Type" parameter. Do not make changes to one of the actions without changing the other.
// Environment Setup

parameter "OutputDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Recent"
parameter "DataDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Enhanced"
//Unused for this one
parameter "Query" = ""
parameter "Type" = "Enhanced-All-JAR"

// Begin: Verve Log4j Detector

action uses wow64 redirection {not x64 of operating system}

prefetch unzip.exe sha1:E1652B058195DB3F5F754B7AB430652AE04A50B8 size:167936 http://software.bigfix.com/download/redist/unzip-5.52.exe sha256:8D9B5190AACE52A1DB1AC73A65EE9999C329157C8E88F61A772433323D6B7A4A

if {version of operating system >= "6.0" as version}
	prefetch handle.zip sha1:C5B70A8A8B485FA4A5F23C453CB75507480CECC2 size:908905 https://download.sysinternals.com/files/Handle.zip sha256:524E61547C8E26608CDA1B11B6E9471616CCCC48530F6E7EC9131EABF839357E
	parameter "handleExtraCmdline" = "-accepteula -nobanner"
elseif {version of operating system < "6.0" as version}
	prefetch handle.zip sha1:D649CC5437B6F867CC3A905389D8C72F7B5922DD size:228012 http://web.archive.org/web/20130508165540if_/http://download.sysinternals.com/files/Handle.zip sha256:DD128A80739011226C5E76172DB03FFA6D4FDEA9E3A723AC82B26C7C74EAEC4D
	parameter "handleExtraCmdline" = ""
endif

utility __Download\unzip.exe

// Setup Handle for usage
waithidden __Download\unzip.exe -o "__Download\handle.zip" -d "__Download"

if {x64 of operating system}
	parameter "handle" = "__Download\handle64.exe"
else 
	parameter "handle" = "__Download\handle.exe"
endif
// Done: Setup Handle for usage

folder delete "{parameter "DataDir"}"
folder create "{parameter "DataDir"}"

delete __appendfile
appendfile {now}
move __appendfile "{parameter "DataDir"}\start.out"

delete "__createfile"
if {parameter "Type" = "Basic-Java-Log4j" or parameter "Type" = "Enhanced-Java-All"}
createfile until _end_
"{parameter "handle"}" -p javaw.exe   {parameter "Query"} {parameter "handleExtraCmdline"}    > "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" -p java.exe    {parameter "Query"} {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" -p javadoc.exe {parameter "Query"} {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" -p javac.exe   {parameter "Query"} {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
_end_
elseif {parameter "Type" = "Basic-All-Log4j"}
createfile until _end_
"{parameter "handle"}" {parameter "Query"} {parameter "handleExtraCmdline"}    > "{parameter "DataDir"}\openhandles.temp.log"
_end_
elseif {parameter "Type" = "Enhanced-All-JAR"} 
createfile until _end_
"{parameter "handle"}" .jar {parameter "handleExtraCmdline"}    > "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .war {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .aar {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .ear {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .nar {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
_end_
endif

delete "run.bat"
move __createfile run.bat

delete "{parameter "DataDir"}\openhandles.temp.log"
delete "{parameter "DataDir"}\openhandles.log"

waithidden run.bat

move "{parameter "DataDir"}\openhandles.temp.log" "{parameter "DataDir"}\openhandles.log"

// End: Verve Log4j Detector

// Begin: Logpresso handling
if {x64 of operating system}
	prefetch openjre.zip sha1:69230F2F769A30334BB2F6314E39BBD9F43FA6EF size:46639244 https://builds.openlogic.com/downloadJDK/openlogic-openjdk-jre/8u292-b10/openlogic-openjdk-jre-8u292-b10-windows-x64.zip sha256:65A77C31DC93970D88E39D1D9B77CD9EA5EF93F1156352D50BEC652E08D21D2C
	parameter "java" = "__Download\openlogic-openjdk-jre-8u292-b10-windows-64\bin\java.exe"
else 
	prefetch openjre.zip sha1:93D5CFEA1B4E5D26B99E3A1EF005D3D961AAD2B1 size:45731200 https://builds.openlogic.com/downloadJDK/openlogic-openjdk-jre/8u292-b10/openlogic-openjdk-jre-8u292-b10-windows-x32.zip sha256:D7116267B08FDB7E5B2EF5F59C103D784DBF64B53B1FAE509111CC563934661A
	parameter "java" = "__Download\openlogic-openjdk-jre-8u292-b10-windows-32\bin\java.exe"
endif

prefetch logpresso.jar sha1:FF965DD30AB4D17A8BD76EF98CA68EB2997D6136 size:41114 https://github.com/logpresso/CVE-2021-44228-Scanner/releases/download/v2.3.1/logpresso-log4j2-scan-2.3.1.jar sha256:EA375B75CC2E58DDEE3E4BEF8976CEFDB9C3B99AB68F618D5B981FBE18BEF7A9

if {exists (following texts of lasts ": " of it) of lines whose (it as lowercase contains ".jar" or it as lowercase contains ".war" or it as lowercase contains ".ear" or it as lowercase contains ".aar" or it as lowercase contains ".nar") of files "openhandles.log" of folders (parameter "DataDir")}
	
	// handle64.exe, handle.exe, and log4j2-scan.exe are now sitting in __Download
	waithidden __Download\unzip.exe -o "__Download\logpresso-log4j2-scan-2.2.0-win64.zip" -d "__Download"
	waithidden __Download\unzip.exe -o "__Download\openjre.zip" -d "__Download"
	
	// Create file containing a list of Log4j JAR files using the Verve Log4j Detector Output
	delete "__appendfile"
	delete "{parameter "DataDir"}\logpresso-paths.in"
	appendfile {concatenations "%0a" of unique values of (following text of last ": " of it) of lines whose (it as lowercase contains ".jar" or it as lowercase contains ".war" or it as lowercase contains ".ear" or it as lowercase contains ".aar" or it as lowercase contains ".nar") of file "openhandles.log" of folder (parameter "DataDir")}
	move __appendfile "{parameter "DataDir"}\logpresso-paths.in"

	// Generic Logpresso Handler
	parameter "logpresso" = "__Download\logpresso.jar"
	
	delete "{parameter "DataDir"}\logpresso-results.csv"
	wait "{parameter "java"}" -jar "{parameter "logpresso"}" -f "{parameter "DataDir"}\logpresso-paths.in" --report-path "{parameter "DataDir"}\logpresso-results.csv"
	continue if {exit code of action = 0 or exit code of action = 1 or exit code of action = 2}

	if {exists lines whose (it contains "VULNERABLE") of files "logpresso-results.csv" of folders (parameter "DataDir")}
		delete "__appendfile"
		delete "{parameter "DataDir"}\logpresso-results.out"
		appendfile {concatenations "%0a" of unique values of (it as string) of ((concatenations "" of substrings separated by "%22" of tuple string item 3 of it, concatenations "" of substrings separated by "%22" of tuple string item 1 of it) of concatenations ", " of substrings separated by "," of it) of lines whose (it contains "VULNERABLE") of file "logpresso-results.csv" of folder (parameter "DataDir")}
		move __appendfile "{parameter "DataDir"}\result.out"
	endif

	if {exists lines whose (it contains "MITIGATED") of files "logpresso-results.csv" of folders (parameter "DataDir")}
		delete "__appendfile"
		delete "{parameter "DataDir"}/mitigated.out"
		appendfile {concatenations "%0a" of unique values of (it as string) of ((concatenations "" of substrings separated by "%22" of tuple string item 3 of it, concatenations "" of substrings separated by "%22" of tuple string item 1 of it) of concatenations ", " of substrings separated by "," of it) of lines whose (it contains "MITIGATED") of file "logpresso-results.csv" of folder (parameter "DataDir")}
		move __appendfile "{parameter "DataDir"}/mitigated.out"
	endif

	// End Generic logpresso Handler
endif

appendfile {parameter "Type"}
move __appendfile "{parameter "DataDir"}\type.out"

delete __appendfile
appendfile {now}
move __appendfile "{parameter "DataDir"}\end.out"

folder delete "{parameter "OutputDir"}"
move "{parameter "DataDir"}" "{parameter "OutputDir"}"

notify client ForceRefresh]]></ActionScript>
			<SuccessCriteria Option="RunToCompletion"></SuccessCriteria>
		</DefaultAction>
		<Action ID="Action1">
			<Description>
				<PreLink>Click </PreLink>
				<Link>here</Link>
				<PostLink><![CDATA[&nbsp;to inspect java processes for vulnerable embedded Log4j components.]]></PostLink>
			</Description>
			<ActionScript MIMEType="application/x-Fixlet-Windows-Shell"><![CDATA[// The only difference between these two actions is the "Query" and "Type" parameter. Do not make changes to one of the actions without changing the other.
// Environment Setup

parameter "OutputDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Recent"
parameter "DataDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Enhanced"
parameter "Query" = "log4j"
parameter "Type" = "Enhanced-All-Log4j"

// Begin: Verve Log4j Detector

action uses wow64 redirection {not x64 of operating system}

prefetch unzip.exe sha1:E1652B058195DB3F5F754B7AB430652AE04A50B8 size:167936 http://software.bigfix.com/download/redist/unzip-5.52.exe sha256:8D9B5190AACE52A1DB1AC73A65EE9999C329157C8E88F61A772433323D6B7A4A

if {version of operating system >= "6.0" as version}
	prefetch handle.zip sha1:C5B70A8A8B485FA4A5F23C453CB75507480CECC2 size:908905 https://download.sysinternals.com/files/Handle.zip sha256:524E61547C8E26608CDA1B11B6E9471616CCCC48530F6E7EC9131EABF839357E
	parameter "handleExtraCmdline" = "-accepteula -nobanner"
elseif {version of operating system < "6.0" as version}
	prefetch handle.zip sha1:D649CC5437B6F867CC3A905389D8C72F7B5922DD size:228012 http://web.archive.org/web/20130508165540if_/http://download.sysinternals.com/files/Handle.zip sha256:DD128A80739011226C5E76172DB03FFA6D4FDEA9E3A723AC82B26C7C74EAEC4D
	parameter "handleExtraCmdline" = ""
endif

utility __Download\unzip.exe

// Setup Handle for usage
waithidden __Download\unzip.exe -o "__Download\handle.zip" -d "__Download"

if {x64 of operating system}
	parameter "handle" = "__Download\handle64.exe"
else 
	parameter "handle" = "__Download\handle.exe"
endif
// Done: Setup Handle for usage

folder delete "{parameter "DataDir"}"
folder create "{parameter "DataDir"}"

delete __appendfile
appendfile {now}
move __appendfile "{parameter "DataDir"}\start.out"

delete "__createfile"
if {parameter "Type" = "Basic-Java-Log4j" or parameter "Type" = "Enhanced-Java-All"}
createfile until _end_
"{parameter "handle"}" -p javaw.exe   {parameter "Query"} {parameter "handleExtraCmdline"}    > "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" -p java.exe    {parameter "Query"} {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" -p javadoc.exe {parameter "Query"} {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" -p javac.exe   {parameter "Query"} {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
_end_
elseif {parameter "Type" = "Basic-All-Log4j"}
createfile until _end_
"{parameter "handle"}" {parameter "Query"} {parameter "handleExtraCmdline"}    > "{parameter "DataDir"}\openhandles.temp.log"
_end_
elseif {parameter "Type" = "Enhanced-All-JAR"} 
createfile until _end_
"{parameter "handle"}" .jar {parameter "handleExtraCmdline"}    > "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .war {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .aar {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .ear {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
"{parameter "handle"}" .nar {parameter "handleExtraCmdline"}    >> "{parameter "DataDir"}\openhandles.temp.log"
_end_
endif

delete "run.bat"
move __createfile run.bat

delete "{parameter "DataDir"}\openhandles.temp.log"
delete "{parameter "DataDir"}\openhandles.log"

waithidden run.bat

move "{parameter "DataDir"}\openhandles.temp.log" "{parameter "DataDir"}\openhandles.log"

// End: Verve Log4j Detector

// Begin: Logpresso handling
if {x64 of operating system}
	prefetch openjre.zip sha1:69230F2F769A30334BB2F6314E39BBD9F43FA6EF size:46639244 https://builds.openlogic.com/downloadJDK/openlogic-openjdk-jre/8u292-b10/openlogic-openjdk-jre-8u292-b10-windows-x64.zip sha256:65A77C31DC93970D88E39D1D9B77CD9EA5EF93F1156352D50BEC652E08D21D2C
	parameter "java" = "__Download\openlogic-openjdk-jre-8u292-b10-windows-64\bin\java.exe"
else 
	prefetch openjre.zip sha1:93D5CFEA1B4E5D26B99E3A1EF005D3D961AAD2B1 size:45731200 https://builds.openlogic.com/downloadJDK/openlogic-openjdk-jre/8u292-b10/openlogic-openjdk-jre-8u292-b10-windows-x32.zip sha256:D7116267B08FDB7E5B2EF5F59C103D784DBF64B53B1FAE509111CC563934661A
	parameter "java" = "__Download\openlogic-openjdk-jre-8u292-b10-windows-32\bin\java.exe"
endif

prefetch logpresso.jar sha1:FF965DD30AB4D17A8BD76EF98CA68EB2997D6136 size:41114 https://github.com/logpresso/CVE-2021-44228-Scanner/releases/download/v2.3.1/logpresso-log4j2-scan-2.3.1.jar sha256:EA375B75CC2E58DDEE3E4BEF8976CEFDB9C3B99AB68F618D5B981FBE18BEF7A9

if {exists (following texts of lasts ": " of it) of lines whose (it as lowercase contains ".jar" or it as lowercase contains ".war" or it as lowercase contains ".ear" or it as lowercase contains ".aar" or it as lowercase contains ".nar") of files "openhandles.log" of folders (parameter "DataDir")}
	
	// handle64.exe, handle.exe, and log4j2-scan.exe are now sitting in __Download
	waithidden __Download\unzip.exe -o "__Download\logpresso-log4j2-scan-2.2.0-win64.zip" -d "__Download"
	waithidden __Download\unzip.exe -o "__Download\openjre.zip" -d "__Download"
	
	// Create file containing a list of Log4j JAR files using the Verve Log4j Detector Output
	delete "__appendfile"
	delete "{parameter "DataDir"}\logpresso-paths.in"
	appendfile {concatenations "%0a" of unique values of (following text of last ": " of it) of lines whose (it as lowercase contains ".jar" or it as lowercase contains ".war" or it as lowercase contains ".ear" or it as lowercase contains ".aar" or it as lowercase contains ".nar") of file "openhandles.log" of folder (parameter "DataDir")}
	move __appendfile "{parameter "DataDir"}\logpresso-paths.in"

	// Generic Logpresso Handler
	parameter "logpresso" = "__Download\logpresso.jar"
	
	delete "{parameter "DataDir"}\logpresso-results.csv"
	wait "{parameter "java"}" -jar "{parameter "logpresso"}" -f "{parameter "DataDir"}\logpresso-paths.in" --report-path "{parameter "DataDir"}\logpresso-results.csv"
	continue if {exit code of action = 0 or exit code of action = 1 or exit code of action = 2}

	if {exists lines whose (it contains "VULNERABLE") of files "logpresso-results.csv" of folders (parameter "DataDir")}
		delete "__appendfile"
		delete "{parameter "DataDir"}\logpresso-results.out"
		appendfile {concatenations "%0a" of unique values of (it as string) of ((concatenations "" of substrings separated by "%22" of tuple string item 3 of it, concatenations "" of substrings separated by "%22" of tuple string item 1 of it) of concatenations ", " of substrings separated by "," of it) of lines whose (it contains "VULNERABLE") of file "logpresso-results.csv" of folder (parameter "DataDir")}
		move __appendfile "{parameter "DataDir"}\result.out"
	endif

	if {exists lines whose (it contains "MITIGATED") of files "logpresso-results.csv" of folders (parameter "DataDir")}
		delete "__appendfile"
		delete "{parameter "DataDir"}/mitigated.out"
		appendfile {concatenations "%0a" of unique values of (it as string) of ((concatenations "" of substrings separated by "%22" of tuple string item 3 of it, concatenations "" of substrings separated by "%22" of tuple string item 1 of it) of concatenations ", " of substrings separated by "," of it) of lines whose (it contains "MITIGATED") of file "logpresso-results.csv" of folder (parameter "DataDir")}
		move __appendfile "{parameter "DataDir"}/mitigated.out"
	endif

	// End Generic logpresso Handler
endif


appendfile {parameter "Type"}
move __appendfile "{parameter "DataDir"}\type.out"

delete __appendfile
appendfile {now}
move __appendfile "{parameter "DataDir"}\end.out"

folder delete "{parameter "OutputDir"}"
move "{parameter "DataDir"}" "{parameter "OutputDir"}"

notify client ForceRefresh]]></ActionScript>
			<SuccessCriteria Option="RunToCompletion"></SuccessCriteria>
		</Action>
	</Fixlet>
</BES>
