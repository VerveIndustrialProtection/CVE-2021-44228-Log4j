<?xml version="1.0" encoding="UTF-8"?>
<BES xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="BES.xsd">
	<Fixlet>
		<Title>Invoke - Verve Log4j Full System Scan - Linux</Title>
		<Description><![CDATA[<P>Invokes the Verve Log4j Full System Scan&nbsp;to detect if there are any Log4j JARs on the system. The Fixlets, "Warning - Verve Log4j Detector reports CVE-####-#### - Universal" will become relevant on machines with vulnerable Log4j versions shortly after this Fixlet completes.</P>
<P>To target only&nbsp;systems actively running java, target the computer group "Systems running Java Processes" that was packaged with this fixlet.</P>
<P><STRONG>Notes<BR></STRONG>This&nbsp;Fixlet does look within all JAR, WAR, EAR, AAR, etc files on the entire disk to see if Log4j is embedded inside of them -- as a result, this Fixlet has a high impact on the system, requires a portable JRE and takes more time.&nbsp;If you do not need this added functionality see the Verve Log4j Detector or Verve Log4j Enhanced Detector.</P>
<P>This Fixlet takes into account whether or not the JNDI class has been removed from the JAR before marking it as vulnerable.</P>
<P><STRONG>Testing</STRONG><BR>You should always test all BigFix content on a representative set of test systems before applying it to production systems. Do not apply content you have not reviewed, tested, and have a real understanding of how it will impact your systems.</P>
<P><STRONG>Copyright Verve Industrial Protection 2021</STRONG><BR>This content is produced, maintained and copyrighted by Verve Industrial Protection. You may use and distribute this content freely but you may not remove this notice. If you modify this content or derive other content from this content you must make the modified content available for free under these same terms. This content carries no Express or Implied Warranty. THE LICENSED PROPERTY IS PROVIDED "AS IS", WITH ALL FAULTS. THERE ARE NO WARRANTIES OR GUARANTEES, EXPRESS OR IMPLIED, RELATING TO THE VERVE INDUSTRIAL PROTECTION IP, THE PROPRIETARY KNOWLEDGE, OR OTHER SERVICES OR PRODUCTS TO BE PROVIDED HEREUNDER, OR ANY PROSPECTS OR OUTCOME THEREOF. VERVE INDUSTRIAL PROTECTION DISCLAIMS ANY AND ALL, AND INSTRUCTOR ACKNOWLEDGES AND AGREES THAT THERE ARE NO, REPRESENTATIONS, WARRANTIES, COVENANTS, OR CONDITIONS, WHETHER EXPRESS, IMPLIED, ARISING AT LAW, IN EQUITY, OR BY CUSTOM OF TRADE, STATUTORY OR OTHERWISE, ORAL OR WRITTEN, INCLUDING WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, NON-INFRINGEMENT, TITLE OR QUIET ENJOYMENT. FURTHER, VERVE INDUSTRIAL PROTECTION DOES NOT WARRANT THAT THE LICENSED PROPERTY IS ERROR-FREE OR WILL BE AVAILABLE AT ALL TIMES OR OPERATE WITHOUT INTERRUPTION. NO ORAL OR WRITTEN INFORMATION OR ADVICE GIVEN BY VERVE INDUSTRIAL PROTECTION, ITS AGENTS, OR ITS EMPLOYEES, AT ANY TIME SHALL CREATE A WARRANTY OF ANY KIND. SOME STATES OR JURISDICTIONS DO NOT ALLOW THE EXCLUSION OF EXPRESS OR IMPLIED WARRANTIES, SO THE ABOVE EXCLUSION MAY NOT APPLY TO YOU. IN THAT EVENT, WARRANTIES SHALL ONLY BE IMPOSED TO THE EXTENT DETERMINED BY A COURT OF COMPETENT JURISDICTION AS REQUIRED BY APPLICABLE LAW.<BR></P>]]></Description>
		<Relevance>unix of operating system</Relevance>
		<Relevance><![CDATA[(not exists modification times whose (it > (now - 30 * minute)) of files "start.out" of folders "__Global/Verve/Detections/Log4j/Recent" of data folders of client)]]></Relevance>
		<Category></Category>
		<Source>Internal</Source>
		<SourceID></SourceID>
		<SourceReleaseDate>2021-12-19</SourceReleaseDate>
		<SourceSeverity></SourceSeverity>
		<CVENames></CVENames>
		<SANSID></SANSID>
		<MIMEField>
			<Name>x-fixlet-modification-time</Name>
			<Value>Sun, 19 Dec 2021 22:39:11 +0000</Value>
		</MIMEField>
		<Domain>BESC</Domain>
		<DefaultAction ID="Action1">
			<Description>
				<PreLink>Click </PreLink>
				<Link>here</Link>
				<PostLink> to deploy this action.</PostLink>
			</Description>
			<ActionScript MIMEType="application/x-Fixlet-Windows-Shell"><![CDATA[// Environment Setup

parameter "OutputDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Recent"
parameter "RuntimeDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Runtime"
parameter "DataDir" = "{pathname of data folder of client}/__Global/Verve/Detections/Log4j/Enhanced"
action parameter query "LogpressoExclusions" with description "Please enter paths (separated by a comma) to be excluded from scanning (Network drives, mount points, etc)" with default "/mnt,/cdrom"
parameter "Type" = "Logpresso-All-JAR"

folder delete "{parameter "DataDir"}"
folder create "{parameter "DataDir"}"

delete __appendfile
appendfile {now}
move __appendfile "{parameter "DataDir"}/start.out"

wait /bin/bash -c 'rm -rf "{parameter "RuntimeDir"}"'
folder create "{parameter "RuntimeDir"}"

// Begin: Logpresso handling
prefetch logpresso.jar sha1:FF965DD30AB4D17A8BD76EF98CA68EB2997D6136 size:41114 https://github.com/logpresso/CVE-2021-44228-Scanner/releases/download/v2.3.1/logpresso-log4j2-scan-2.3.1.jar sha256:EA375B75CC2E58DDEE3E4BEF8976CEFDB9C3B99AB68F618D5B981FBE18BEF7A9

if {architecture of operating system = "x86_64"}
	prefetch openjre.tar.gz sha1:6A30C541FB7D141F8D34A1F2D5CA3B70FCF437FF size:41045860 https://builds.openlogic.com/downloadJDK/openlogic-openjdk-jre/8u292-b10/openlogic-openjdk-jre-8u292-b10-linux-x64.tar.gz sha256:B51EF522D35B23EE2469BB2324B365FFDD9773420329ECE675BDFCF1B9365AE4
else
	prefetch openjre.tar.gz sha1:2F9A0AC58A8A212473521321242E07CC76BD0EFE size:40585042 https://builds.openlogic.com/downloadJDK/openlogic-openjdk-jre/8u292-b10/openlogic-openjdk-jre-8u292-b10-linux-x32.tar.gz sha256:57211788D6B1BEA3AE0C47F61A97F3259FFA91019A29AB3055AD7C580ADF02CE
endif

wait tar --no-same-permissions --no-same-owner -xf "__Download/openjre.tar.gz" -C "{parameter "RuntimeDir"}"
continue if {exit code of action = 0}

parameter "java" = "{pathnames of files "java" of folders "bin" of folders of folders (parameter "RuntimeDir")}"

// Generic Logpresso Handler

parameter "logpresso" = "__Download/logpresso.jar"

delete "{parameter "DataDir"}/logpresso-results.csv"

// the --exclude-pattern substitution takes the users list, places an --exclude-pattern infront of each entry and wraps the entry in quotes
// If they do not provide an exclusion then it evalutes to nothing
wait "{parameter "java"}" -jar "{parameter "logpresso"}" --no-symlink {concatenations " " of ("--exclude-pattern %22" & it & "%22") of it whose (it != "") of (it as trimmed string) of substrings separated by "," of parameter "LogPressoExclusions"} --exclude-fs cifs,nfs,nfs3,nfs4,tmpfs,devtmpfs,iso9660,smbfs,gfs,gfs2,safenetfs,smb,smb2,afs --report-path "{parameter "DataDir"}/logpresso-results.csv" /
parameter "success" = "{exists true whose (if true then ((exit code of action = 0) or (exit code of action = 1) or (exit code of action = 2)) else false)}"

// Remove the Java Runtime before checking success
wait /bin/bash -c "rm -rf '{parameter "RuntimeDir"}'"

// Do not proceed of logpresso errored out. This lets us fail the action
continue if {(parameter "success") as boolean}

if {exists lines whose (it contains "VULNERABLE") of files "logpresso-results.csv" of folders (parameter "DataDir")}
	delete "__appendfile"
	delete "{parameter "DataDir"}/result.out"
	appendfile {concatenations "%0a" of unique values of (it as string) of ((concatenations "" of substrings separated by "%22" of tuple string item 3 of it, concatenations "" of substrings separated by "%22" of tuple string item 1 of it) of concatenations ", " of substrings separated by "," of it) of lines whose (it contains "VULNERABLE") of file "logpresso-results.csv" of folder (parameter "DataDir")}
	move __appendfile "{parameter "DataDir"}/result.out"
endif

if {exists lines whose (it contains "MITIGATED") of files "logpresso-results.csv" of folders (parameter "DataDir")}
	delete "__appendfile"
	delete "{parameter "DataDir"}/mitigated.out"
	appendfile {concatenations "%0a" of unique values of (it as string) of ((concatenations "" of substrings separated by "%22" of tuple string item 3 of it, concatenations "" of substrings separated by "%22" of tuple string item 1 of it) of concatenations ", " of substrings separated by "," of it) of lines whose (it contains "MITIGATED") of file "logpresso-results.csv" of folder (parameter "DataDir")}
	move __appendfile "{parameter "DataDir"}/mitigated.out"
endif

appendfile {parameter "Type"}
move __appendfile "{parameter "DataDir"}/type.out"

delete __appendfile
appendfile {now}
move __appendfile "{parameter "DataDir"}/end.out"

folder delete "{parameter "OutputDir"}"
move "{parameter "DataDir"}" "{parameter "OutputDir"}"]]></ActionScript>
			<SuccessCriteria Option="RunToCompletion"></SuccessCriteria>
		</DefaultAction>
	</Fixlet>
</BES>
